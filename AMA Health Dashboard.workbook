{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# AMA Health Dashboard"
      },
      "name": "headertext"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "b859a03f-2283-43dd-8536-42714bbfced6",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "isRequired": true,
            "query": "resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| summarize by subscriptionId\r\n| project value = strcat('/subscriptions/', subscriptionId), label = subscriptionId, selected = true",
            "crossComponentResources": [
              "value::selected"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": "/subscriptions/ebb79bc0-aa86-44a7-8111-cabbe0c43993"
          },
          {
            "id": "e101dbda-5c3b-469e-a505-7377f2ff5a43",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| summarize by id, name\r\n| project label = id, value = id, selected = true",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "900928f5-74ee-4858-a407-89d223037394",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRangeSelect",
            "label": "Time Range",
            "type": 4,
            "isRequired": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ]
            },
            "value": {
              "durationMs": 1209600000
            }
          },
          {
            "id": "86f10d6d-188b-4ece-b754-94329c4750b0",
            "version": "KqlParameterItem/1.0",
            "name": "UnhealthyCriteria",
            "label": "Unhealthy Criteria",
            "type": 2,
            "isRequired": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n    {\"value\":\"1m\",\"label\":\"1 minute without heartbeat\",\"selected\":false},\r\n    {\"value\":\"5m\",\"label\":\"5 minute without heartbeat\",\"selected\":false},\r\n    {\"value\":\"30m\",\"label\":\"30 minute without heartbeat\",\"selected\":true},\r\n    {\"value\":\"1h\",\"label\":\"1 hour without heartbeat\",\"selected\":false},\r\n    {\"value\":\"2h\",\"label\":\"2 hour without heartbeat\",\"selected\":false},\r\n    {\"value\":\"8h\",\"label\":\"8 hour without heartbeat\",\"selected\":false},\r\n    {\"value\":\"1d\",\"label\":\"1 day without heartbeat\",\"selected\":false},\r\n    {\"value\":\"2d\",\"label\":\"2 day without heartbeat\",\"selected\":false},\r\n    {\"value\":\"7d\",\"label\":\"7 day without heartbeat\",\"selected\":false}\r\n]",
            "value": "5m"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "Parameters"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "eb4c7bea-78f2-43c7-aa05-58cc76a7495d",
            "version": "KqlParameterItem/1.0",
            "name": "selectedTab",
            "type": 1,
            "description": "Override selected tab parameter ",
            "isRequired": true,
            "isGlobal": true,
            "query": "{\"version\":\"1.0.0\",\"content\":\"[\\r\\n    { \\\"value\\\":\\\"SubOverview\\\", \\\"label\\\": \\\"SubOverview\\\", \\\"selected\\\":true }\\r\\n]\",\"transformers\":null}",
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 8,
            "value": "Overview"
          },
          {
            "id": "361f1434-6df1-4fd6-8aa9-bc5b111d4887",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceTypeSelected",
            "type": 1,
            "isGlobal": true,
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "value": "ALL_Res_Types"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "global-selectedtab-param"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "c589405c-2088-47db-a595-3ec5ab73c503",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Get Started",
            "subTarget": "GetStarted",
            "style": "link"
          },
          {
            "id": "68c2939f-96a0-4208-8c07-a981cefb434d",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Overview",
            "subTarget": "Overview",
            "style": "link"
          },
          {
            "id": "c7a87cea-5a51-45b7-85b9-96c6dfc2d174",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Virtual Machines",
            "subTarget": "AzureVM",
            "style": "link"
          },
          {
            "id": "8f544ec4-fb9b-4da0-88d3-21b232099ce2",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Arc-enabled Servers",
            "subTarget": "ArcVM",
            "style": "link"
          },
          {
            "id": "2e3d7c23-a2e4-4658-934b-77dd33dced9e",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Data Collection Rules",
            "subTarget": "DCR",
            "style": "link"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "AgentCount",
        "comparison": "isNotEqualTo",
        "value": "0"
      },
      "name": "tabs"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Get Started Info",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Get started\r\n\r\nWelcome to the AMA Health Dashboard.\r\nUse this workbook to review the Health of Subscription and Workspaces.\r\n* Agent Health\r\n* Agent Health Trend\r\n* Distribution by resource type, resource platform, agent version\r\n* Top agents by CPU usage"
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "GetStarted"
            },
            "name": "abouttext"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "GetStarted"
      },
      "name": "GetStartedInfo"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Data Collection Rules"
            },
            "name": "dcr-header"
          },
          {
            "type": 1,
            "content": {
              "json": "This tab lists all the rules within the selected subscription. These rules are required to centrally configure and operationalize the new Azure Monitor Agent (AMA), when associated to machines running the new agent. They define where to collect the data from (i.e. ‘Data Source’), where to send the data to (i.e. ‘Destination’) and any custom processing or filtering for the data. Click on the rule name > ‘Configuration’ > ‘Resources’ to view the associated machines. [Learn more](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/data-collection-rule-overview)\r\n\r\n*Note: Data Collection Rules need to exist in the same physical location as the workspace, but they can be associated with machines in any other location or subscription.*\r\n",
              "style": "info"
            },
            "name": "dcr-text"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "parameters": [
                {
                  "id": "2e4a9de0-88d4-4922-9079-ebe218c7c292",
                  "version": "KqlParameterItem/1.0",
                  "name": "DCRCount",
                  "type": 2,
                  "query": "resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| extend wsid = tolower(id)\r\n| where wsid == tolower({Workspace:value})\r\n| project wsid, name\r\n| join kind=leftouter (\r\nresources\r\n| where type == \"microsoft.insights/datacollectionrules\"\r\n| extend provisioningState = properties.provisioningState,\r\n    description = properties.description,\r\n    sentineltag = tags.createdBy,\r\n    dataSources = properties.dataSources,\r\n    destinations = properties.destinations\r\n| extend workspace = destinations.logAnalytics\r\n| mv-expand workspace\r\n| extend wsid = tostring(workspace.workspaceResourceId)\r\n| project wsname = name, wsid\r\n) on wsid\r\n| extend dcrcount = iff(isempty(wsname), 0, 1)\r\n| project label = dcrcount, value = dcrcount, selected = true",
                  "crossComponentResources": [
                    "{Subscription}"
                  ],
                  "isHiddenWhenLocked": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "value": null
                }
              ],
              "style": "pills",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "name": "parameters - 6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{Subscription:Id}/providers/Microsoft.Insights/dataCollectionRules\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2021-04-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"name\",\"columnid\":\"Name\"},{\"path\":\"$..workspaceResourceId\",\"columnid\":\"Workspace\"},{\"path\":\"kind\",\"columnid\":\"OS\"},{\"path\":\"properties.dataFlows[*].streams[0]\",\"columnid\":\"Streams\",\"substringRegexMatch\":\"(Microsoft-)*(\\\\w+)\",\"substringReplace\":\"$2\"},{\"path\":\"$..xPathQueries\",\"columnid\":\"xPath\"},{\"path\":\"location\",\"columnid\":\"Location\"},{\"path\":\"$..facilityNames\",\"columnid\":\"SyslogFacilities\"}]}}]}",
              "size": 0,
              "queryType": 12,
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "SyslogFacilities",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "SyslogFacilities",
                  "sortOrder": 1
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "0",
              "comparison": "isEqualTo",
              "value": "0"
            },
            "name": "DCR-ARM-Query"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.insights/datacollectionrules\"\r\n| extend provisioningState = properties.provisioningState,\r\n    description = properties.description,\r\n    sentineltag = tags.createdBy,\r\n    dataSources = properties.dataSources,\r\n    destinations = properties.destinations\r\n//| mv-expand destinations\r\n| extend workspace = destinations.logAnalytics\r\n| mv-expand workspace\r\n| extend wsid = tolower(workspace.workspaceResourceId)\r\n| where wsid == tolower({Workspace:value})\r\n| extend Sentinel = iff(sentineltag == \"Sentinel\", \"True\", \"False\")\r\n| extend DataSource = case(dataSources contains \"extensions\", \"Extensions\", \r\n                    dataSources contains \"syslog\", \"Syslog\", \r\n                    dataSources contains \"windowsEventLogs\", \"EventLogs\", \r\n                    dataSources contains \"performanceCounters\", \"Performance\", \"Other\")\r\n| extend destination = case(destinations contains \"logAnalytics\", \"Log Analytics Workspace\", \r\n                    destinations contains \"azureMonitorMetrics\", \"Metrics\", \"Other\")\r\n| project id, name, subscriptionId, provisioningState, description, Sentinel, resourceGroup, DataSource, destination, wsid",
              "size": 0,
              "showAnalytics": true,
              "title": "DCRs",
              "noDataMessage": "No Data Collection Rules fond in the selected subscription(s). Consider converting your current data collections to Data Collection Rules - read more here: https://docs.microsoft.com/en-us/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agentr ",
              "noDataMessageStyle": 2,
              "exportFieldName": "id",
              "exportParameterName": "DCRId",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "provisioningState",
                    "formatter": 1
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "0",
              "comparison": "isEqualTo",
              "value": "0"
            },
            "name": "DCR-query",
            "styleSettings": {
              "padding": "2"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"adf85a26-679e-4778-befc-274847dcb16c\",\"mergeType\":\"innerunique\",\"leftTable\":\"DCR-ARM-Query\",\"rightTable\":\"DCR-query\",\"leftColumn\":\"Name\",\"rightColumn\":\"name\"}],\"projectRename\":[{\"originalName\":\"[DCR-query].id\",\"mergedName\":\"id\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-ARM-Query].Location\",\"mergedName\":\"Location\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-query].resourceGroup\",\"mergedName\":\"resourceGroup\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-ARM-Query].Name\",\"mergedName\":\"Name\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-ARM-Query].OS\",\"mergedName\":\"OS\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-ARM-Query].Streams\",\"mergedName\":\"Streams\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-query].DataSource\",\"mergedName\":\"DataSource\",\"fromId\":\"unknown\"},{\"originalName\":\"[DCR-query].destination\",\"mergedName\":\"destination\",\"fromId\":\"unknown\"},{\"originalName\":\"[DCR-ARM-Query].Workspace\",\"mergedName\":\"Workspace\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-ARM-Query].xPath\",\"mergedName\":\"xPath\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-ARM-Query].SyslogFacilities\",\"mergedName\":\"SyslogFacilities\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-query].name\",\"mergedName\":\"name\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-query].subscriptionId\",\"mergedName\":\"subscriptionId\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-query].provisioningState\",\"mergedName\":\"provisioningState\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-query].description\",\"mergedName\":\"description\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-query].Sentinel\",\"mergedName\":\"Sentinel\",\"fromId\":\"adf85a26-679e-4778-befc-274847dcb16c\"},{\"originalName\":\"[DCR-query].wsid\",\"mergedName\":\"wsid\",\"fromId\":\"unknown\"}]}",
              "size": 0,
              "title": "{$rowCount} Data Collection rules in {Subscription:name} for {Workspace:label}",
              "noDataMessage": "No Data Collection Rules exist in this subscription with this workspace as a target.",
              "showRefreshButton": true,
              "exportedParameters": [
                {
                  "fieldName": "Name",
                  "parameterName": "DCR",
                  "parameterType": 1
                },
                {
                  "fieldName": "resourceGroup",
                  "parameterName": "DCRrg",
                  "parameterType": 1
                }
              ],
              "showExportToExcel": true,
              "queryType": 7,
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "id",
                    "formatter": 13,
                    "formatOptions": {
                      "linkTarget": "Resource",
                      "linkIsContextBlade": true,
                      "showIcon": true,
                      "customColumnWidthSetting": "35ch"
                    }
                  },
                  {
                    "columnMatch": "Location",
                    "formatter": 17,
                    "formatOptions": {
                      "customColumnWidthSetting": "16ch"
                    }
                  },
                  {
                    "columnMatch": "resourceGroup",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "Name",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "OS",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "destination",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Log Analytics Workspace",
                          "representation": "Log",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Workspace",
                    "formatter": 13,
                    "formatOptions": {
                      "linkTarget": "Resource",
                      "linkIsContextBlade": true,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "xPath",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "SyslogFacilities",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "name",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "subscriptionId",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "provisioningState",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "description",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "wsid",
                    "formatter": 5
                  }
                ],
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "id",
                    "label": "Data Collection Rule"
                  },
                  {
                    "columnId": "resourceGroup",
                    "label": "Resource Group"
                  },
                  {
                    "columnId": "destination",
                    "label": "Destination"
                  },
                  {
                    "columnId": "Workspace",
                    "label": "Workspace"
                  },
                  {
                    "columnId": "wsid",
                    "label": "yo yo ma"
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "DCRCount",
              "comparison": "isEqualTo",
              "value": "1"
            },
            "showPin": false,
            "name": "DCR-Merged"
          },
          {
            "type": 1,
            "content": {
              "json": "No Data Collection Rules fond in the selected subscription with this workspace ({Workspace:label}) as a target. Consider converting your current data collections to Data Collection Rules - [read more here](https://docs.microsoft.com/en-us/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent)",
              "style": "upsell"
            },
            "conditionalVisibility": {
              "parameterName": "DCRCount",
              "comparison": "isEqualTo",
              "value": "0"
            },
            "name": "nodcr-text"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{Subscription:Id}/resourceGroups/{DCRrg}/providers/Microsoft.Insights/dataCollectionRules/{DCR}/associations\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2021-04-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"id\",\"columnid\":\"VMs\",\"substringRegexMatch\":\"(\\\\/subscriptions.*)(\\\\/providers.*|Providers.*)\",\"substringReplace\":\"$1\"}]}}]}",
              "size": 0,
              "title": "VMs associated with {DCR}",
              "noDataMessage": "No Virtual Machines associated with this data collection rule. See [Configure data colletion for the Azure Monitor Agent](https://docs.microsoft.com/en-us/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent) to see how you can associate virtual machines.",
              "noDataMessageStyle": 2,
              "queryType": 12
            },
            "conditionalVisibility": {
              "parameterName": "DCR",
              "comparison": "isNotEqualTo"
            },
            "name": "DCRVms"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "DCR"
      },
      "name": "DCRGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Agent Health",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let heartbeatCount = (\r\nHeartbeat\r\n| where (TimeGenerated {TimeRangeSelect:query})\r\n| where Category == \"Azure Monitor Agent\"\r\n| summarize arg_max(TimeGenerated, *) by Computer\r\n| extend ResType = \r\n    case(ResourceProvider == \"Microsoft.HybridCompute\" and ComputerEnvironment == \"Non-Azure\" and _ResourceId != \"\", \"Arc-enabled Servers\",\r\n        _ResourceId has \"tenants\", \"Windows Client Devices\",\r\n        ResourceProvider == \"Microsoft.Compute\" and ResourceType != \"virtualMachineScaleSets\" and ComputerEnvironment != \"Non-Azure\", \"Virtual Machines\",\r\n        \"Other\" )\r\n| where ResType == '{ResourceTypeSelected}' or 'ALL_Res_Types' == '{ResourceTypeSelected}' or '' == '{ResourceTypeSelected}'//single selection\r\n| summarize LastHeartbeat = max(TimeGenerated) by Computer\r\n| extend State = iff(LastHeartbeat < ago({UnhealthyCriteria}), 'Unhealthy', 'Healthy')\r\n| summarize Count = dcount(Computer) by State);\r\ndatatable(State:string, Rank:int)[\"Unhealthy\", 0, \"Healthy\", 1]\r\n| join kind = leftouter heartbeatCount on State\r\n| extend Count = iff(isempty(State1), 0, Count)\r\n| project-away State1\r\n| extend Rank = iff(State == 'Unhealthy' and Count == 0, 2, Rank)\r\n| order by Rank asc\r\n| project-reorder State, Count",
              "size": 1,
              "title": "Agent Health Snapshot : {ResourceTypeSelected}",
              "showRefreshButton": true,
              "exportMultipleValues": true,
              "exportedParameters": [
                {
                  "fieldName": "series",
                  "parameterName": "AgentHealthSelection",
                  "parameterType": 1
                }
              ],
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Unhealthy",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Healthy",
                    "color": "green"
                  }
                ]
              }
            },
            "customWidth": "33",
            "name": "Agent health",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let heartbeatCount = (\r\nHeartbeat\r\n| where TimeGenerated > ago(14d)\r\n| where Category == \"Azure Monitor Agent\"\r\n| extend ResType = \r\n    case(ResourceProvider == \"Microsoft.HybridCompute\" and ComputerEnvironment == \"Non-Azure\" and _ResourceId != \"\", \"Arc-enabled Servers\",\r\n        _ResourceId has \"tenants\", \"Windows Client Devices\",\r\n        ResourceProvider == \"Microsoft.Compute\" and ResourceType != \"virtualMachineScaleSets\" and ComputerEnvironment != \"Non-Azure\", \"Virtual Machines\",\r\n        \"Other\" )\r\n| where ResType == '{ResourceTypeSelected}' or 'ALL_Res_Types' == '{ResourceTypeSelected}' or '' == '{ResourceTypeSelected}'//single selection\r\n| extend timeSegment = bin_at(TimeGenerated,1d,now())\r\n| summarize LastHeartbeat = max(TimeGenerated) by Computer, timeSegment\r\n| extend State = iff(LastHeartbeat < (timeSegment + 1d - {UnhealthyCriteria}), 'Unhealthy', 'Healthy')\r\n| summarize Count = dcount(Computer) by State, timeSegment\r\n);\r\nheartbeatCount\r\n| order by timeSegment asc, State asc\r\n| project-reorder timeSegment, State, Count",
              "size": 1,
              "aggregation": 3,
              "title": "Agent health over selected period {ResourceTypeSelected}",
              "showRefreshButton": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "barchart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Unhealthy",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Healthy",
                    "color": "green"
                  }
                ]
              }
            },
            "customWidth": "66",
            "name": "Agent health over selected period",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Heartbeat\r\n| where (TimeGenerated {TimeRangeSelect:query})\r\n| where Category == \"Azure Monitor Agent\"\r\n| summarize arg_max(TimeGenerated, *) by Computer\r\n| extend ResType = \r\n    case(ResourceProvider == \"Microsoft.HybridCompute\" and ComputerEnvironment == \"Non-Azure\" and _ResourceId != \"\", \"Arc-enabled Servers\",\r\n        _ResourceId has \"tenants\", \"Windows Client Devices\",\r\n        ResourceProvider == \"Microsoft.Compute\" and ResourceType != \"virtualMachineScaleSets\" and ComputerEnvironment != \"Non-Azure\", \"Virtual Machines\",\r\n        \"Other\" )\r\n| summarize MachineCount = count() by ResType\r\n//| where MachineCount > 0\r\n| sort by MachineCount desc",
              "size": 1,
              "title": "Distribution by Resource Type",
              "showRefreshButton": true,
              "exportFieldName": "series",
              "exportParameterName": "ResourceTypeSelected",
              "exportDefaultValue": "ALL_Res_Types",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Arc-enabled Servers",
                    "color": "orange"
                  },
                  {
                    "seriesName": "Virtual Machines",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "Windows client deWindows Client Devicesvices",
                    "color": "gray"
                  }
                ]
              }
            },
            "customWidth": "30",
            "name": "Distribution By Resource Type",
            "styleSettings": {
              "showBorder": true
            }
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "OverviewAgentHealth"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let TimeData = (Heartbeat\r\n| where TimeGenerated {TimeRangeSelect:query}\r\n| where Category == \"Azure Monitor Agent\"\r\n| summarize arg_max(TimeGenerated, *) by Computer\r\n| extend ResType = \r\n    case(ResourceProvider == \"Microsoft.HybridCompute\" and ComputerEnvironment == \"Non-Azure\" and _ResourceId != \"\", \"Arc-enabled Servers\",\r\n        _ResourceId has \"tenants\", \"Windows Client Devices\",\r\n        ResourceProvider == \"Microsoft.Compute\" and ResourceType != \"virtualMachineScaleSets\" and ComputerEnvironment != \"Non-Azure\", \"Virtual Machines\",\r\n        \"Other\" )\r\n| where ResType == '{ResourceTypeSelected}' or 'ALL_Res_Types' == '{ResourceTypeSelected}' or '' == '{ResourceTypeSelected}'//single selection\r\n| summarize LastHeartbeat = max(TimeGenerated) by Computer\r\n| extend State = iff(LastHeartbeat < ago({UnhealthyCriteria}), 'Unhealthy', 'Healthy')\r\n| extend TimeFromNow = now() - LastHeartbeat\r\n| extend [\"TimeAgo\"] = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n);\r\nlet DetailsData = (\r\nHeartbeat\r\n| where TimeGenerated {TimeRangeSelect:query}\r\n| where Category == \"Azure Monitor Agent\"\r\n| extend Packed = pack_all()\r\n);\r\nlet HealthStateTrend = ( \r\nHeartbeat\r\n| where TimeGenerated {TimeRangeSelect:query}\r\n| where Category == \"Azure Monitor Agent\"\r\n| make-series InternalTrend=iff(count() > 0, 1, 0) default = 0 on TimeGenerated from {TimeRangeSelect:start} to {TimeRangeSelect:end} step {UnhealthyCriteria} by Computer\r\n| extend Trend=array_slice(InternalTrend, array_length(InternalTrend) - 30, array_length(InternalTrend)-1)\r\n| extend (s_min, s_minId, s_max, s_maxId, s_avg, s_var, s_stdev) = series_stats(Trend)\r\n| project Computer, Trend, s_avg\r\n);\r\nTimeData | join DetailsData on Computer\r\n| where TimeGenerated == LastHeartbeat\r\n| join HealthStateTrend on Computer\r\n| order by State, s_avg asc, TimeAgo\r\n| project   [\"Resource Id\"]=ResourceId,    \r\n            [\"_ComputerName_\"] = Computer, \r\n            [\"Computer\"]=strcat('🖥️ ', Computer), \r\n            [\"Environment\"] = iff(ComputerEnvironment == \"Azure\", \r\n            ComputerEnvironment, Category), \r\n            [\"OS\"]=iff(isempty(OSName), OSType, OSName),\r\n            [\"Subscription\"]=SubscriptionId,\r\n            Version, \r\n            [\"Time\"]=strcat('🕒 ', TimeAgo), \r\n            State,\r\n            [\"Heartbeat Trend\"]=Trend, \r\n            [\"Details\"]=Packed\r\n//| where State == '{AgentHealthSelection}' or 'ALL' == '{AgentHealthSelection}' //single selection\r\n| where todynamic('{AgentHealthSelection}') has State or \"\" == '{AgentHealthSelection}' //Multiple Selection from agent health chart",
        "size": 0,
        "title": "Agent Details {AgentHealthSelection} {ResourceTypeSelected}",
        "noDataMessageStyle": 4,
        "showRefreshButton": true,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Resource Id",
              "formatter": 13,
              "formatOptions": {
                "linkTarget": "Resource",
                "linkIsContextBlade": true,
                "showIcon": true
              }
            },
            {
              "columnMatch": "_ComputerName_",
              "formatter": 5
            },
            {
              "columnMatch": "Computer",
              "formatter": 5
            },
            {
              "columnMatch": "State",
              "formatter": 0,
              "tooltipFormat": {
                "tooltip": "Click to see details of the last event sent by this computer."
              }
            },
            {
              "columnMatch": "Environment",
              "formatter": 5
            },
            {
              "columnMatch": "Subscription",
              "formatter": 15,
              "formatOptions": {
                "linkTarget": "Resource",
                "linkIsContextBlade": true,
                "showIcon": true
              }
            },
            {
              "columnMatch": "Heartbeat Trend",
              "formatter": 10,
              "formatOptions": {
                "palette": "redGreen"
              },
              "tooltipFormat": {
                "tooltip": "Each bar represents the bucket of time based on the Unhealthy Criteria. Showing last 30 buckets max."
              }
            },
            {
              "columnMatch": "Details",
              "formatter": 5
            },
            {
              "columnMatch": "Subscription Id",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "Url",
                "linkIsContextBlade": false
              }
            },
            {
              "columnMatch": "SubId",
              "formatter": 15,
              "formatOptions": {
                "linkTarget": "Resource",
                "linkIsContextBlade": true,
                "showIcon": true
              }
            }
          ]
        },
        "sortBy": []
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "Agent Details"
    }
  ],
  "fallbackResourceIds": [
    "azure monitor"
  ],
  "fromTemplateId": "community-Workbooks/Azure Monitor - Agents/Agent Migration Tracker",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}